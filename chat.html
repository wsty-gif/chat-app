<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat - LINE風</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:"Helvetica Neue",sans-serif; background:#e5ddd5; display:flex; flex-direction:column; height:100vh; }
  header { background:#075e54; color:#fff; text-align:center; padding:16px; font-size:22px; font-weight:bold; }
  #chat-container { flex:1; display:flex; flex-direction:column; padding:12px; overflow-y:auto; }
  .row { display:flex; margin-bottom:10px; }
  .row.user { justify-content:flex-end; }
  .row.assistant { justify-content:flex-start; }
  .bubble { max-width:75%; padding:14px 18px; border-radius:20px; line-height:1.5; word-wrap:break-word; font-size:17px; }
  .row.user .bubble { background:#dcf8c6; border-bottom-right-radius:4px; }
  .row.assistant .bubble { background:#fff; border-bottom-left-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.15); }
  #input-area { display:flex; padding:12px; background:#f0f0f0; border-top:1px solid #ccc; }
  #input { flex:1; border:1px solid #ccc; border-radius:25px; padding:14px 16px; font-size:18px; resize:none; max-height:220px; overflow-y:auto; }
  #send { margin-left:10px; background:#075e54; color:#fff; border:none; border-radius:25px; padding:0 22px; font-size:18px; cursor:pointer; }
  #send:disabled { opacity:0.5; cursor:not-allowed; }
  @media (max-width:600px){
    .bubble { max-width:85%; font-size:16px; padding:12px 16px; }
    #input { font-size:16px; padding:12px 14px; }
    #send { font-size:16px; padding:0 18px; }
  }
</style>
</head>
<body>
<header>AIチャット</header>
<div id="chat-container"></div>
<div id="input-area">
  <textarea id="input" rows="1" placeholder="メッセージを入力"></textarea>
  <button id="send">送信</button>
</div>

<script>
const API_KEY = "AIzaSyAGJBEf57Wb3L_PemkLC7kk0YsD5oKGK3c"; // ブラウザキー
const MODEL = "gemini-1.5-flash";

const elMessages = document.getElementById('chat-container');
const elInput = document.getElementById('input');
const elSend = document.getElementById('send');
const history = [];

function addBubble(role, text) {
  const row = document.createElement('div');
  row.className = `row ${role}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  row.appendChild(bubble);
  elMessages.appendChild(row);
  elMessages.scrollTop = elMessages.scrollHeight;
  return bubble;
}

async function sendMessage() {
  const text = (elInput.value||'').trim();
  if(!text) return;
  elInput.value = ''; elInput.style.height='auto';
  addBubble('user', text);
  history.push({ role:'user', content:text });
  elSend.disabled = true;
  const thinkingEl = addBubble('assistant','…');

  try{
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          // ここで履歴も送信可能
          "messages": history.map(m => ({ role:m.role, content:[{ text:m.content }] }))
        })
      }
    );
    const data = await res.json();
    // data.candidates が正しく返る場合
    const reply = data.candidates?.[0]?.content?.[0]?.text || '(返答なし)';
    thinkingEl.textContent = reply;
    history.push({ role:'assistant', content:reply });
  } catch(e){
    thinkingEl.textContent = 'エラーが発生しました';
    console.error(e);
  } finally{
    elSend.disabled=false;
    elInput.focus();
  }
}

elSend.addEventListener('click',sendMessage);
elInput.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});
elInput.addEventListener('input',()=>{
  elInput.style.height='auto';
  elInput.style.height=Math.min(elInput.scrollHeight,220)+'px';
});

addBubble('assistant','こんにちは！ご用件を教えてください。');
</script>
</body>
</html>
